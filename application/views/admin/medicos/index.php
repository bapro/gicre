<style>td,th{text-align:left}.fa.fa-check,.fa.fa-history,em{color:red;font-size:11px;text-transform:lowercase}</style><?php $this->padron_database=$this->load->database('padron',TRUE);if($perfil=="Admin"){$controller="admin";}else{$controller="medico";}$today=date('Y-m-d'); ?><body><div class="col-md-12"><div class="row"><a href="<?php echo site_url("$controller/create_cita"); ?>"class="btn btn-primary btn-xs">Buscar/Crear Paciente</a><hr id="hr_ad"></div></div><div class="col-md-12"><div class="row"><div style="display:<?=$displayTotInfo?>"><select class="form-control select2"style="background:#e0e5e6;width:100%"id="by-doctor"><option value="0"><?=$countTotalCitaDocNum?></option><?php foreach($countTotalCitaDoc as $rowtd){$doctot=$this->db->select('name')->where('id_user',$rowtd->doctor)->get('users')->row('name');echo '<option value="'.$rowtd->doctor.'">Dr '.$doctot.' : '.$rowtd->Total.' cita(s) </option>';}echo "</select>";echo "<br/><br/>";echo "</div>";if($perfil=="Asistente Medico"){ ?><form action="<?php echo site_url("$controller/SeachCitaResultAs"); ?>"class="form-inline"><div class="col-md-3"><select class="form-control select2"style="background:#e0e5e6;width:100%"id="doctor"name="doctor"><option value="">Seleccione un medico</option><?php $sql="SELECT id_doctor FROM centro_doc_as WHERE id_asdoc =$iduser group by id_doctor";$query=$this->db->query($sql);foreach($query->result()as $row){$name=$this->db->select('name')->where('id_user',$row->id_doctor)->get('users')->row('name');echo '<option value="'.$row->id_doctor.'">Dr '.$name.'</option>';} ?></select></div><?php }else{ ?><form action="<?php echo site_url("$controller/SeachCitaResult"); ?>"class="form-inline"><div class="col-md-3"><select class="form-control select2"style="background:#e0e5e6;width:100%"name="centro"><?php foreach($centro_medico as $row){echo '<option value="'.$row->id_m_c.'">'.$row->name.'</option>';} ?></select></div><?php } ?><div class="col-md-9"style="background:#e0e5e6;border:1px solid #38a7bb"><div class="form-group"><label for="desde"style="font-size:10px">Desde</label><input class="form-control"id="date_from"name="date_from"readonly value="<?=date('d-m-Y')?>"></div><div class="form-group"><label for="hasta"style="font-size:10px">Hasta</label><input class="form-control"id="date_to"name="date_to"readonly value="<?=date('d-m-Y')?>"></div><button class="btn btn-primary btn-xs"disabled id="click_button"type="submit"><i class="fa fa-search"></i></button><?php if($perfil=="Asistente Medico"){}else{if($appointments!=NULL){ ?><a href="<?php echo base_url("printings/print_hoy_cita1/$iduser/$perfil") ?>"class="btn-sm"title="Imprimir Las Citas de Hoy"target="_blank"><i class="fa"style="font-size:24px"></i></a><?php }} ?></div></form><span id="flash1"></span></div><hr id="hr_ad"><div class="row"id="dis"><label>Buscar un paciente de hoy</label> <select class="form-control select2"style="background:#e0e5e6;width:100%"id="search-hoy-patient"><option value="">Seleccione todos los pacientes de hoy</option><?php foreach($patientHoyQ as $pathoy){$patienthoy=$this->db->select('nombre')->where('id_p_a',$pathoy->id_patient)->get('patients_appointments')->row('nombre');echo '<option value="'.$pathoy->id_patient.'">'.$patienthoy.'</option>';} ?></select><br><br><div style="overflow-x:auto"><div id="load-citas-hoy"><table cellspacing="0"class="sort-me table table-striped"id=""style="margin:auto"><thead><tr style="background:#5957f7;color:#fff"><th><strong>Foto</strong></th><th><strong>NEC</strong></th><th><strong>Paciente</strong></th><th><strong>Fecha Propuesta</strong></th><th><strong>Centro</strong></th><th><strong>Doctor</strong></th><th><strong>Historial Medica</strong></th><th><strong>Acciones</strong></th></tr></thead><tbody><?php $today=date('Y-m-d');$this->padron_database=$this->load->database('padron',TRUE);foreach($appointments as $ver){$id_p_a_h=encrypt_url($ver->id_patient);$id_user_h=encrypt_url($iduser);$id_cm_h=encrypt_url($ver->centro);$from_view = encrypt_url(0);$patient=$this->db->select('nombre,photo,ced1,ced2,ced3,frecuencia')->where('id_p_a',$ver->id_patient)->get('patients_appointments')->row_array();$q=$this->db->select('id_patient')->where('id_patient',$ver->id_patient)->where('doctor',$ver->doctor)->where('centro',$ver->centro)->like('update_time',date("Y-m-d"))->get('rendez_vous');$sql_con="SELECT historial_id FROM h_c_enfermedad where filter_date='$today' AND historial_id=$ver->id_patient AND user_id=$ver->doctor AND centro_medico=$ver->centro";$atendido_con=$this->db->query($sql_con);$area_d=$this->db->select('title_area')->where('id_ar',$ver->area)->get('areas')->row("title_area");if($atendido_con->num_rows()>0){$atend="<i style='color:green' class='fa fa-check' aria-hidden='true'></i>";$title_hist="&#013 Hay una historial medica por hoy";$hist=1;}else{$atend="";$hist=0;$title_hist="";}$hist_h=encrypt_url($hist);$sqlcita="SELECT id_rdv FROM factura2 where id_rdv=$ver->id_apoint";$cita_con=$this->db->query($sqlcita);if($cita_con->num_rows()>0){$cita='#B8FFD3';$thay_fac1="<span title='cita facturada' style='color:green;font-size:11px'>RD$</span>";}else{$cita="";$thay_fac1="";}$freq="SELECT historial_id FROM h_c_enfermedad WHERE  historial_id=$ver->id_patient AND user_id=$ver->doctor group by filter_date";$cita_freq=$this->db->query($freq);if($cita_freq->num_rows()==0){$frecuencia_text="";$frecuencia_nbr="";}else if($cita_freq->num_rows()==1){$frecuencia_text="$cita_freq->num_rows vista";$frecuencia_nbr="$cita_freq->num_rows";}else{$frecuencia_text="$cita_freq->num_rows vistas";$frecuencia_nbr="$cita_freq->num_rows";} ?><tr style="background:<?=$cita?>"title="<?=$title_hist?>"><td><?php if($patient['photo']=="padron"){$photo=$this->padron_database->select('IMAGEN')->where('MUN_CED',$patient['ced1'])->where('SEQ_CED',$patient['ced2'])->where('VER_CED',$patient['ced3'])->get('fotos')->row('IMAGEN');if($photo){echo '<img width="75px"    src="data:image/jpeg;base64,'.base64_encode($photo).'" />';}else{echo '<img  style="width:75px;" src="'.base_url().'/assets/img/user.png"  />';}}else if($patient['photo']==""){ ?><img src="<?=base_url()?>/assets/img/user.png"width="75px"><?php }else{ ?><img src="<?=base_url()?>/assets/img/patients-pictures/<?php echo $patient['photo']; ?>"width="75px"><?php } ?></td><td><?=$ver->nec?></td><td style="text-transform:uppercase"><a href="<?php echo site_url("$controller/patient/$ver->id_patient/$ver->centro/$ver->doctor"); ?>"><?=$patient['nombre']?></a></td><td><?=$ver->fecha_propuesta?></td><td style="text-transform:uppercase"><?php $centro=$this->db->select('name,type')->where('id_m_c',$ver->centro)->get('medical_centers')->row_array(); ?><a href="<?php echo site_url("$controller/centro_medico/".$ver->centro); ?>"><?=$centro['name']?></a></td><td style="text-transform:uppercase"><?php $doctor=$this->db->select('name')->where('id_user',$ver->doctor)->get('users')->row('name');if($perfil=="Admin"){ ?><a href="<?php echo site_url("admin/doctor/".$ver->doctor); ?>"title="<?=$area_d?>"><?=$doctor?></a><?php }else{echo $doctor;} ?></td><td style="text-transform:uppercase"><?php if($perfil=="Admin"){$areaid_ad=encrypt_url(0); ?><a href="<?php echo site_url("$controller/historial_medical/$id_p_a_h/$id_user_h/$areaid_ad/$id_cm_h/$hist_h/$id_user_h/$from_view"); ?>"><i class="fa fa-history"aria-hidden="true"title="ir a la historia clinica"></i><?=$atend?><em title="<?=$frecuencia_text?>"><?=$frecuencia_nbr?></em></a><?php }else if($perfil=="Medico"){$areaid_ad=encrypt_url($area_id); ?><a href="<?php echo site_url("$controller/historial_medical/$id_p_a_h/$id_user_h/$areaid_ad/$id_cm_h/$hist_h/$id_user_h/$from_view"); ?>"><i class="fa fa-history"aria-hidden="true"title="ir a la historia clinica"></i><?=$atend?><em title="<?=$frecuencia_text?>"><?=$frecuencia_nbr?></em></a><?php }else if($perfil=="Asistente Medico"&&$centro['type']=="privado"){$doctor_h=encrypt_url($ver->doctor);$areaid=$this->db->select('area')->where('id_user',$ver->doctor)->get('users')->row('area');$areaid_ad=encrypt_url($areaid);$hist_ha=encrypt_url(4); ?><a href="<?php echo site_url("$controller/historial_medical/$id_p_a_h/$doctor_h/$areaid_ad/$id_cm_h/$hist_ha/$id_user_h/$from_view"); ?>"><i class="fa fa-history"aria-hidden="true"title="ir a la historia clinica"></i><?=$atend?><em title="<?=$frecuencia_text?>"><?=$frecuencia_nbr?></em></a><?php }else{echo "<span style='color:red;font-size:15px'>No tiene acceso a la historia clinica</span>";} ?></td><td><?php if($cita_con->num_rows()==0&&$atendido_con->num_rows()==0){ ?><a style="color:red;cursor:pointer"title="Cancelar la cita"class="cancelar-cita"id="<?=$ver->id_apoint?>"><i class="fa fa-remove"></i></a> <a href="<?php echo site_url("admin_medico/UpdateCita/$ver->id_apoint/$iduser/0") ?>"class="btn-programar"title="Reprogramar la cita"data-target="#EditC"data-toggle="modal"><i class="fa fa-pencil"aria-hidden="true"></i></a><?php }echo $thay_fac1; ?></td></tr><?php } ?></tbody></table><div class="pagination"style="float:right"><?php echo $links; ?></div></div></div></div><br><br></div><br></div></body><?php $this->load->view('footer'); ?><div class="fade modal"id="EditC"role="dialog"><div class="modal-dialog modal-md"><div class="modal-content"><div class="modal-body"></div></div></div></div><script src="https://code.jquery.com/jquery-2.1.1.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script><script src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script><script src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap.min.js"></script><script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script><script src="https://momentjs.com/downloads/moment-with-locales.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script><script src="<?=base_url()?>assets/js/custom.js"></script><script type="text/javascript">function disabledserach(){var o=new Date,l=o.getMonth()+1,e=o.getDate(),t=((""+e).length<2?"0":"")+e+"-"+((""+l).length<2?"0":"")+l+"-"+o.getFullYear();$("#date_from").val()==t&&$("#date_to").val()==t?$("#click_button").prop("disabled",!0):$("#click_button").prop("disabled",!1)}$("#EditC").on("hidden.bs.modal",function(){$(this).removeData("bs.modal")}),$(".cancelar-cita").click(function(){if(confirm("¿Estás seguro de cancelar esta cita?")){var l=this,o=$(this).attr("id");$.ajax({type:"POST",url:"<?=base_url('admin_medico/cancelCita')?>",data:{id:o,iduser:<?=$iduser?>},success:function(o){$(l).closest("tr").css("background","tomato"),$(l).closest("tr").fadeOut(800,function(){$(this).remove()})}})}}),$("#doctor").on("change",function(){$("#load-citas-hoy").html('<span style="text-align:center"> <img   src="<?=base_url()?>assets/img/loading.gif" /> cargando las citas...</span>');var o=$(this).val();$.ajax({type:"POST",url:"<?=base_url('admin_medico/get_centro_cita_doc')?>",data:{iduser:<?=$iduser?>,id_doc:o},success:function(o){$("#load-citas-hoy").html(o)}})}),$("#by-doctor").on("change",function(){$("#load-citas-hoy").html('<span style="text-align:center"> <img   src="<?=base_url()?>assets/img/loading.gif" /> cargando las citas...</span>');var o=$(this).val();0!=o?$.ajax({type:"POST",url:"<?=base_url('admin/getConfirmSolicitudByDoc')?>",data:{iduser:<?=$iduser?>,id_doc:o},success:function(o){$("#load-citas-hoy").html(o)},error:function(o,l,e){alert("An erroroccurred... Look at the console (F12 or Ctrl+Shift+I, Console tab) for more information!"),$("#load-citas-hoy").html("<p>statuscode: "+o.status+"</p><p>errorThrown: "+e+"</p><p>jqXHR.responseText:</p><div>"+o.responseText+"</div>"),console.log("jqXHR:"),console.log(o),console.log("textStatus:"),console.log(l),console.log("errorThrown:"),console.log(e)}}):location.reload()}),$("#search-hoy-patient").on("change",function(){$("#load-citas-hoy").html('<span style="text-align:center"> <img   src="<?=base_url()?>assets/img/loading.gif" /> cargando las citas...</span>');var o=$(this).val();0!=o?$.ajax({type:"POST",url:"<?=base_url('admin_medico/searchPatientPorHoy')?>",data:{id_pat:o,iduser:<?=$iduser?>,perfil:"<?=$perfil?>",area_id:<?=$area_id?>,controller:"<?=$controller?>"},success:function(o){$("#load-citas-hoy").html(o)},error:function(o,l,e){alert("An erroroccurred... Look at the console (F12 or Ctrl+Shift+I, Console tab) for more information!"),$("#load-citas-hoy").html("<p>statuscode: "+o.status+"</p><p>errorThrown: "+e+"</p><p>jqXHR.responseText:</p><div>"+o.responseText+"</div>"),console.log("jqXHR:"),console.log(o),console.log("textStatus:"),console.log(l),console.log("errorThrown:"),console.log(e)}}):location.reload()}),$(".select2").select2({tags:!0,language:{noResults:function(){return"No hay resultado"}}}),$("#date_from").datepicker({dateFormat:"dd-mm-yy"}),$("#date_to").datepicker({onSelect:function(){disabledserach()},dateFormat:"dd-mm-yy"})</script>