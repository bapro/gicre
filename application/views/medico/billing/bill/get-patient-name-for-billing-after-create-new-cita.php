<div class="col-sm-12 searchb"id="dont-display-me-when-pop"><br><form class="form-inline"><div class="form-group"><label>Fecha:</label> <input class="form-control"value="<?=date("d-m-Y")?>"id="fecha-fac"></div><div class="form-group"><label class="wait1">No Autorizacion:</label> <input class="form-control change-red"id="numauto"></div><div class="form-group"><label class="wait2">Autorizado por:</label> <input class="form-control change-red"id="autopor"></div></form><br></div><div class="col-sm-12 searchb showdown3"><?php if($identificar=="privado"){$tarif="Doctor Tarifarios ";}else{$tarif="Centro Tarifarios";}foreach($patient_data as $row) ?><h2 align="center"class="h2">FACTURA</h2><div style="overflow-x:auto"><table class="tab_logic table table-bordered table-condensed table-striped turf"id="turf"><thead><tr class="trback"><?php if($identificar=="privado"){if(empty($serv)){$display="style='display:none'";}else{$display="";} ?><th class="heading"><?php if(empty($serv)){echo "<span style='color:#B18904'><form method='post' action='".base_url()."admin_medico/import_rates_fac'>
	<input type='hidden' name='id_doc' value='$id_doc'/>
	<input type='hidden' name='id_seguro' value='$id_seguro'/>
	<input type='hidden' name='plan' value='$planOcentro'/>
	<input type='hidden' name='name' value='$name'/>
	<input type='submit' value='No hay tarifarios crear'/></form></span>";$disabled="disabled";$display="none";}else{echo $tarif;$disabled="";} ?></th><?php }else{if(empty($serv_centro)){$display="style='display:none'";}else{$display="";} ?><th class="heading"><?php if(empty($serv_centro)){echo "<span style='color:#B18904'>No hay servicios | <a  href='".base_url()."admin_medico/import_rates_fac_centro/$id_cm/$id_seguro/$name'>Crear</a></span>";$disabled="disabled";$display="none";}else{echo $tarif;$disabled="";} ?></th><?php } ?><th class="heading">Cantidad</th><th class="heading">Precio Unitario</th><th class="heading">Sub-Total</th><th class="heading">Total Pagar Seguro</th><th class="heading">Descuento</th><th class="heading">Total Pagar Paciente</th><?php if($identificar=="privado"){if(empty($serv)){$display="style='display:none'";}else{$display="";} ?><td></td><?php }else{if(empty($serv_centro)){$display="style='display:none'";}else{$display="";} ?><td></td><?php } ?></tr></thead><tfoot><tr class="grand-total persist"style="background:#d5d370;font-size:18px"><th colspan="3">TOTALES</th><th>RD$ <span id="table-grand-total">0.00</span></th><th>RD$ <span id="seguro-grand-total">0.00</span></th><th style="color:red">RD$ <span id="descuento-grand-total">0.00</span></th><th>RD$ <span id="tot-paciente-grand-total">0.00</span></th><th style="background:#fff"><?php if($identificar=="privado"){if(empty($serv)){$display="display:none";}else{$display="";} ?><button id="add_row"style="cursor:pointer;font-size:13px;color:#00f;background:#fff;<?=$display?>"type="button"disabled title="Añadir fila"><span class="glyphicon glyphicon-plus-sign"></span></button><?php }else{if(empty($serv_centro)){$display="display:none";}else{$display="";} ?><button id="add_row_c"style="cursor:pointer;font-size:13px;color:#00f;background:#fff;<?=$display?>"type="button"disabled title="Añadir fila"><span class="glyphicon glyphicon-plus-sign"></span></button><?php } ?></th></tr><tr><td colspan="8"id="delete_row"style="color:red;font-size:13px;display:none;cursor:pointer;background:#fff;text-align:right"title="Borrar fila con casilla marcada"><span class="glyphicon glyphicon-minus-sign"></span></td><td colspan="8"></td></tr></tfoot><tbody><tr class="change-red calculation visible"id="addr1"><td style="width:180px;display:block"><?php if($identificar=="privado"){ ?><select class="form-control select2 service option-select1"onchange="getSegName(this)"id="consultTafFromWebservice"><option value=""hidden></option><?php foreach($serv as $s){ ?><option value="<?=$s->id_tarif?>"><?=$s->procedimiento?></option><?php } ?></select><?php }else{ ?><select class="form-control change-red select-option-centro1 select2 service"onchange="getSegNameCentro(this)"><option value=""hidden></option><?php foreach($serv_centro as $s){ ?><option value="<?=$s->id_c_taf?>"><?=$s->sub_groupo?></option><?php } ?></select><?php } ?></td><td class="cantidad"><input class="form-control cantidad"value="1"tabindex="1"onkeypress="return validateQty(event)"></td><td class="precio"><div class="input-group"><span class="input-group-addon">RD$</span> <input class="form-control float precio"tabindex="2"onkeypress="return onlyfloat(event)"></div></td><td class="row-total"><div class="input-group"><span class="input-group-addon">RD$</span> <input class="form-control row-total"value="0.00"readonly></div></td><td class="total-pag-seg"><div class="input-group"><span class="input-group-addon">RD$</span> <input class="form-control total-pag-seg"value="0.00"id="webSerPrecio"></div></td><td class="descuento"><div class="input-group"><span class="input-group-addon">RD$</span> <input class="form-control float descuento"tabindex="4"onkeypress="return onlyfloat(event)"style="color:red"></div></td><td class="total-pag-pa"><div class="input-group"><span class="input-group-addon">RD$</span> <input class="form-control total-pag-pa"value="0.00"readonly tabindex="5"></div></td><td></td></tr><tr class="calculation visible"id="addr2"></tbody></table><div style="color:red"id="required_fac"></div></div></div><div class="col-sm-12 searchb showdown3"><br><div style="overflow-x:auto"><div class="col-sm-9"><input id="total-pagar-paciente"type="hidden"> <input id="descuento1"type="hidden"> <input id="total-pago-seguro"type="hidden"> <input id="sub-total"type="hidden"> <textarea class="form-control"id="comment"placeholder="Comentario"rows="10"></textarea><br></div><div class="col-sm-3"><button id="save_factura"style="margin-left:14px"type="button"class="btn btn-success"<?=$disabled?>><i class="fa fa-save"></i> Guardar</button></div></div></div><div class="loadf"></div><script src="https://code.jquery.com/jquery-2.2.0.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script><script src="//code.jquery.com/ui/1.11.3/jquery-ui.js"></script>
 <script>$(".select2").select2({}),$("#fecha-fac").datepicker({dateFormat:"dd-mm-yy",maxDate:"-1d"}),$("#check-if-is-as-medico").click((function(){})),Number.prototype.format=function(t,e){var a="\\d(?=(\\d{"+(e||3)+"})+"+(t>0?"\\.":"$")+")";return this.toFixed(Math.max(0,~~t)).replace(new RegExp(a,"g"),"$&,")};let countNbEx=0;function getSegName(t){countNbEx++,$(".loadf").fadeIn().html('<span style="font-size:24px" class="glyphicon glyphicon-refresh glyphicon-refresh-animate load"></span>');$.ajax({type:"POST",url:"<?php echo site_url('factura/get_service_precio');?>",data:{id_mssm1:t.value,doctorid:"<?=$id_doc ?>",nap:$("#numauto").val(),countNbEx:countNbEx},success:function(e){$($(t).parents("tr")[0]).find("input.total-pag-seg").val(e),recalc(),$(".loadf").hide(),$("#add_row").prop("disabled",!1)}})}function getSegNameCentro(t){$(".loadf").fadeIn().html('<span style="font-size:24px" class="glyphicon glyphicon-refresh glyphicon-refresh-animate load"></span>'),$.ajax({type:"POST",url:"<?php echo site_url('factura/get_service_precio_centro');?>",data:{id_mssm1:t.value},success:function(e){$($(t).parents("tr")[0]).find("input.total-pag-seg").val(e),recalc(),$(".loadf").hide(),$("#add_row_c").prop("disabled",!1)}})}var numRows=2,ti=5;function isNumber(t){return!isNaN(parseFloat(t))&&isFinite(t)}function recalc(){var t=0;ss=0,dd=0,pp=0,$("#turf").find("tr").each((function(){var e=$(this).find("input.cantidad").val()*$(this).find("input.precio").val(),a=$(this).find("input.total-pag-seg").val(),o=$(this).find("input.descuento").val(),n=e-a-o;$(this).find("input.total-pag-pa").val(n.toFixed(2)?n.toFixed(2):""),$(this).find("input.row-total").val(e.toFixed(2)?e.toFixed(2):""),t+=isNumber(e)?e:0,ss+=isNumber(a)?parseInt(a,10):0,dd+=isNumber(o)?parseInt(o,10):0,pp+=isNumber(n)?n:0})),$("#table-grand-total").html(t.format(2)),$("#sub-total").val(t),$("#seguro-grand-total").html(ss.format(2)),$("#total-pago-seguro").val(ss),$("#descuento-grand-total").html(dd.format(2)),$("#descuento1").val(dd),$("#tot-paciente-grand-total").html(pp.format(2)),$("#total-pagar-paciente").val(pp)}function addRow(){$("#add_row").prop("disabled",!0),$("#addr"+numRows).html("<td style='width:180px;display:block'><select class='service form-control select2 option-select2' onChange='getSegName(this);'></select></td><td class='cantidad'><input value='1' name='cantidad"+numRows+"' type='text' class='cantidad form-control'  tabindex='"+ti+++"' onkeypress='return validateQty(event);' /></td><td class='precio'><div class='input-group'><span class='input-group-addon'>RD$</span><input  name='precio"+numRows+"' type='text' class='precio form-control float'  tabindex='"+ti+++"' onkeypress='return onlyfloat(event);' /></div></td><td class='row-total'><div class='input-group'><span class='input-group-addon'>RD$</span><input type='text' class='row-total form-control' value='0.00' readonly /></div></td><td class='total-pag-seg'><div class='input-group'><span class='input-group-addon'>RD$</span><input  name='totalpagseg"+numRows+"' type='text' class='total-pag-seg form-control'  tabindex='"+ti+++"'  /></div></td><td class='descuento'><div class='input-group'><span class='input-group-addon'>RD$</span><input style='color:red' name='descuento"+numRows+"' type='text' class='descuento form-control float'  tabindex='"+ti+++"'onkeypress='return onlyfloat(event);' /></div></td><td class='total-pag-pa'><div class='input-group'><span class='input-group-addon'>RD$</span><input  name='totalpagpa"+numRows+"' type='text' class='total-pag-pa form-control ' value='0.00' tabindex='"+ti+++"' readonly /></div></td><td><input type='checkbox' name='chkbox' class='remove'></td>");var t=$(".option-select1 > option").clone();$(".option-select2").append(t),$(".select2").select2(),$("#turf tr:last").after('<tr id="addr'+(numRows+1)+'" class="calculation visible"></tr>'),numRows++,$("#delete_row").slideDown()}function addRowC(){$("#add_row_c").prop("disabled",!0),$("#addr"+numRows).html("<td style='width:180px;display:block'><select class='service form-control select2 select-option-centro2' onChange='getSegNameCentro(this);'></select></td><td class='cantidad'><input value='1' name='cantidad"+numRows+"' type='text' class='cantidad form-control'  tabindex='"+ti+++"' onkeypress='return validateQty(event);' /></td><td class='precio'><div class='input-group'><span class='input-group-addon'>RD$</span><input  name='precio"+numRows+"' type='text' class='precio form-control float'  tabindex='"+ti+++"' onkeypress='return onlyfloat(event);' /></div></td><td class='row-total'><div class='input-group'><span class='input-group-addon'>RD$</span><input type='text' class='row-total form-control' value='0.00' readonly /></div></td><td class='total-pag-seg'><div class='input-group'><span class='input-group-addon'>RD$</span><input  name='totalpagseg"+numRows+"' type='text' class='total-pag-seg form-control'  tabindex='"+ti+++"'  /></div></td><td class='descuento'><div class='input-group'><span class='input-group-addon'>RD$</span><input style='color:red' name='descuento"+numRows+"' type='text' class='descuento form-control float'  tabindex='"+ti+++"'onkeypress='return onlyfloat(event);' /></div></td><td class='total-pag-pa'><div class='input-group'><span class='input-group-addon'>RD$</span><input  name='totalpagpa"+numRows+"' type='text' class='total-pag-pa form-control ' value='0.00' tabindex='"+ti+++"' readonly /></div></td><td><input type='checkbox' name='chkbox' class='remove'></td>");var t=$(".select-option-centro1 > option").clone();$(".select-option-centro2").append(t),$(".select2").select2(),$("#turf tr:last").after('<tr id="addr'+(numRows+1)+'" class="calculation visible"></tr>'),numRows++,$("#delete_row").slideDown()}function delRow(){$('input[name="chkbox"]').each((function(){$(this).is(":checked")&&$(this).parents("tr").remove()})),$('input[name="chkbox"]').length<1&&$("#delete_row").slideUp()}function validateQty(t){var e=window.event?t.keyCode:t.which;return 8==t.keyCode||46==t.keyCode||37==t.keyCode||39==t.keyCode||!(e<48||e>57)}function onlyfloat(t){var e=(t=t||window.event).which?t.which:t.keyCode;return!(e>31&&(e<48||e>57))||46==t.which&&-1==$(".float").val().indexOf(".")}$((function(){$("#turf").on("click",".calculation",recalc),$("#turf").on("keyup blur",".form-control",recalc),$("#add_row").on("click",(function(){addRow()})),$("#add_row_c").on("click",(function(){addRowC()})),$("#delete_row").on("click",(function(){delRow(),recalc()}))}));$('#save_factura').on('click', function(event) { var cant = $('input.cantidad').val(); var prec = $('input.precio').val(); var numauto = $('#numauto').val(); var autopor = $('#autopor').val();var servField = $('.service').val();var patient_id = "<?=$id_p_a?>"; var area = "<?=$area?>"; var id_apoint = "<?=$id_apoint?>"; var medico = "<?=$id_doc?>"; var centro_medico = "<?=$id_cm?>"; var seguro_medico = "<?=$id_seguro?>"; var codigoprestado = "<?=$cod?>"; var fecha = $('#fecha-fac').val(); var inserted_by = "<?=$name?>"; var is_admin = "<?=$is_admin?>"; var tsubtotal = $('#sub-total').val(); var totpagseg = $('#total-pago-seguro').val(); var totsubdesc = $('#descuento1').val(); var totpagpa = $('#total-pagar-paciente').val(); var comment = $('#comment').val(); var identificar="<?=$identificar?>"; var service = []; var cantidad = []; var precio = []; var total = []; var totalpaseg = []; var descuento = []; var totpapat = []; $('.service').each(function(){ service.push($(this).val()); }); $('input.cantidad').each(function(){ cantidad.push($(this).val()); }); $('input.precio').each(function(){ precio.push($(this).val()); }); $('input.row-total').each(function(){ total.push($(this).val()); }); $('input.total-pag-seg').each(function(){ totalpaseg.push($(this).val()); }); $('input.descuento').each(function(){ descuento.push($(this).val()); }); $('input.total-pag-pa').each(function(){ totpapat.push($(this).val()); }); $(".loadf").fadeIn().html('<span class="glyphicon glyphicon-refresh glyphicon-refresh-animate load"></span>'); $.ajax({ type: "POST", dataType: 'json', url: "<?=base_url('factura/SaveBill')?>", data: {service:service,cantidad:cantidad,preciouni:precio,tsubtotal:tsubtotal,totpagseg:totpagseg,totsubdesc:totsubdesc,totpagpa:totpagpa,subtotal:total,totalpaseg:totalpaseg,descuento:descuento,totpapat:totpapat, seguro_medico:seguro_medico,patient_id:patient_id,medico:medico,codigoprestado:codigoprestado,fecha:fecha,id_apoint:id_apoint,is_admin:is_admin, numauto:numauto,autopor:autopor,comment:comment,inserted_by:inserted_by,area:area,centro_medico:centro_medico,cant:cant,prec:prec,servField:servField}, cache: true, success:function(response){ if(response.status == 1){ $('.loadf').html('<p class="alert alert-danger">'+response.message+'</p>'); } else if(response.status == 2){ $('.loadf').html('<p class="alert alert-danger">'+response.message+'</p>'); }else if(response.status == 3){$('#required_fac').html('<p class="alert alert-danger ">'+response.message+'</p>').fadeIn('slow').delay(4000).fadeOut('slow');$(".change-red").css("border-color", "red");$(".change-red").find(".form-control").not(".descuento").css("border-color", "red");$(".loadf").fadeIn().html('');}else{ var idfacc = response.status; if("<?=$is_admin?>"=="no"){ window.location.href = "<?php echo site_url('medico/bill_'); ?>/" + idfacc + "/" +identificar; }else{ window.location.href = "<?php echo site_url('admin/bill_'); ?>/" + idfacc + "/" +identificar; } } }, error: function(jqXHR, textStatus, errorThrown) { alert('An error occurred... Look at the console (F12 or Ctrl+Shift+I, Console tab) for more information!'); $('.loadf').html('<p>status code: '+jqXHR.status+'</p><p>errorThrown: ' + errorThrown + '</p><p>jqXHR.responseText:</p><div>'+jqXHR.responseText + '</div>'); console.log('jqXHR:'); console.log(jqXHR); console.log('textStatus:'); console.log(textStatus); console.log('errorThrown:'); console.log(errorThrown); }, }); return false; });</script>