<?php defined('BASEPATH')OR exit('No direct script access allowed');class InvoiceArsClaim extends CI_Controller{public function __construct(){parent::__construct();$this->load->model('model_admin');$this->load->model('navigation/account_demand_model');}function getDateRanch(){$id_user=$this->input->post('id_user');$perfil=$this->input->post('perfil');$begin=$this->input->post('begin');if($begin==0){$order_by="ORDER BY filter_date DESC";}else{$order_by="ORDER BY filter_date ";}$group_by='GROUP BY filter_date';if($perfil=='Admin'){$where="WHERE seguro_medico !=11";}elseif($perfil=="Medico"){$where="WHERE seguro_medico !=11 AND medico=$id_user";}else{$where="JOIN doctor_centro_medico ON doctor_centro_medico.centro_medico=factura2.centro_medico WHERE seguro_medico !=11  AND id_doctor=$id_user";}$sql="SELECT factura2.centro_medico, filter_date FROM factura2 $where $group_by $order_by";$query=$this->db->query($sql);echo "<option value=''></option>";foreach($query->result()as $dr){$desde=date("d-m-Y",strtotime($dr->filter_date));echo '<option value="'.$dr->filter_date.'">'.$desde.'</option>';}}function invoiceARS(){$id_user=$this->input->get('id_user');$hasta=$this->input->get('hasta');$desde=$this->input->get('desde');$perfil=$this->db->select('perfil')->where('id_user',$id_user)->get('users')->row('perfil');if($perfil=="Admin"){$sql="SELECT seguro_medico FROM factura2 WHERE seguro_medico !=11 AND filter_date >='$desde' AND filter_date <='$hasta' GROUP BY seguro_medico";$query=$this->db->query($sql);}else if($perfil=="Medico"){$sql="SELECT seguro_medico FROM factura2 WHERE seguro_medico !=11 AND filter_date >='$desde' AND filter_date <='$hasta' AND medico=$id_user GROUP BY seguro_medico";$query=$this->db->query($sql);}else{$as_medico_centro=$this->db->select('centro_medico')->where('id_doctor',$id_user)->get('doctor_centro_medico')->row('centro_medico');$sql="SELECT seguro_medico FROM factura2 WHERE seguro_medico !=11 AND filter_date >='$desde' AND filter_date <='$hasta'  GROUP BY seguro_medico";$query=$this->db->query($sql);}echo '<option value="" ></option>';foreach($query->result()as $row){$seguro=$this->db->select('title')->where('id_sm',$row->seguro_medico)->get('seguro_medico')->row('title');echo '<option value="'.$row->seguro_medico.'">'.$seguro.'</option>';}}function invoiceMedico(){$centro=$this->input->get('centro');$area=$this->input->get('area');$perfil=$this->input->get('perfil');$sql="SELECT id_doctor FROM doctor_agenda_test JOIN users ON doctor_agenda_test.id_doctor=users.id_user
 WHERE id_centro=$centro AND area=$area GROUP BY id_doctor";$query=$this->db->query($sql);echo '<option value="" ></option>';foreach($query->result()as $row){$name=$this->db->select('name')->where('id_user',$row->id_doctor)->get('users')->row('name');echo '<option value="'.$row->id_doctor.'">'.$name.'</option>';}}function invoicePatient(){$id_user=$this->input->get('id_user');$hasta=$this->input->get('hasta');$desde=$this->input->get('desde');$perfil=$this->db->select('perfil')->where('id_user',$id_user)->get('users')->row('perfil');if($perfil=="Admin"){$sql="SELECT paciente FROM factura2 WHERE seguro_medico !=11 AND filter_date >='$desde' AND filter_date <='$hasta' GROUP BY paciente";$query=$this->db->query($sql);}else if($perfil=="Medico"){$sql="SELECT paciente FROM factura2 WHERE seguro_medico !=11 AND filter_date >='$desde' AND filter_date <='$hasta' AND medico=$id_user  GROUP BY paciente";$query=$this->db->query($sql);}else{$as_medico_centro=$this->db->select('centro_medico')->where('id_doctor',$id_user)->get('doctor_centro_medico')->row('centro_medico');$sql="SELECT paciente FROM factura2 WHERE seguro_medico !=11 AND filter_date >='$desde' AND filter_date <='$hasta' GROUP BY paciente";$query=$this->db->query($sql);}echo '<option value="" ></option>';foreach($query->result()as $row){$paciente=$this->db->select('nombre')->where('id_p_a',$row->paciente)->get('patients_appointments')->row('nombre');echo '<option value="'.$row->paciente.'">'.$paciente.'</option>';}}function get_fac_ars1(){$data['id_user']=$this->input->get('id_user');$desde=$this->input->get('desde');$hasta=$this->input->get('hasta');$areas=$this->input->get('areas');$medico=$this->input->get('medico');$centro=$this->input->get('centro');$patient=$this->input->get('patient');$checktype=$this->input->get('checktype');if($patient!=""){$data['patient']=$patient;}else{$data['patient']=0;}$seguro_medico=$this->input->get('ars');$data['desde']=$desde;$data['hasta']=$hasta;$data['area']=$areas;$data['centro']=$centro;$data['seguro_medico']=$seguro_medico;if($checktype=='privado'){if($patient==""&&$areas==""&&$medico!=""){$data['condition_fac']="filter_date BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND  seguro_medico= $seguro_medico AND centro_medico= $centro AND medico=$medico";$data['condition_inv']="fecha BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND center_id = $centro AND medico=$medico AND seguro_medico=$seguro_medico";}elseif($patient==""&&$areas!=""&&$medico!=""){$data['condition_fac']="filter_date BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND centro_medico = $centro AND seguro_medico= $seguro_medico AND area=$areas AND  medico=$medico";$data['condition_inv']="fecha BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND center_id = $centro AND area_id=$areas AND seguro_medico=$seguro_medico";}else{$data['condition_fac']="filter_date BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND centro_medico = $centro AND seguro_medico= $seguro_medico AND area=$areas AND medico=$medico AND paciente = $patient";$data['condition_inv']="fecha BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND center_id = $centro AND area_id=$areas AND seguro_medico=$seguro_medico AND medico=$medico AND paciente = $patient";}}else{$data['condition_fac']="filter_date BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND seguro_medico=$seguro_medico AND centro_medico= $centro";$data['condition_inv']="fecha BETWEEN "."'".$desde."'"." AND "."'".$hasta."' AND seguro_medico=$seguro_medico AND center_id= $centro";}$data['is_admin']=$this->input->get('is_admin');$this->load->view('admin/billing/invoice_ars_claim/get_fac_ars',$data);}function saveInvoiceArsClaim(){$fecha=$this->input->post('fecha');$nota=$this->input->post('nota');$ncf=$this->input->post('ncf');$paciente=$this->input->post('paciente');$num_af=$this->input->post('num_af');$numauto=$this->input->post('numauto');$tsubtotal=$this->input->post('tsubtotal');$totpagseg=$this->input->post('totpagseg');$totpagpa=$this->input->post('totpagpa');$medico=$this->input->post('medico');$area=$this->input->post('area');$centro=$this->input->post('centro');$servicio=$this->input->post('servicio');$codigoprestado=$this->input->post('codigoprestado');$rnc=$this->input->post('rnc');$seguro_medico=$this->input->post('seguro_medico');$idfacc=$this->input->post('idfacc');$idfac2=$this->input->post('idfac2');$time=date("Y-m-d H:i:s");$data=array('value'=>$this->input->post('ncf'),'nota'=>$this->input->post('nota'));$id_ncf=$this->model_admin->ncf($data);for($i=0;$i<count($fecha);++$i){$f=$fecha[$i];$ar=$area[$i];$cent=$centro[$i];$pa=$paciente[$i];$nf=$num_af[$i];$na=$numauto[$i];$ts=$tsubtotal[$i];$tp=$totpagseg[$i];$tpg=$totpagpa[$i];$med=$medico[$i];$serv=$servicio[$i];$cod=$codigoprestado[$i];$rn=$rnc[$i];$sm=$seguro_medico[$i];$if=$idfacc[$i];$if2=$idfac2[$i];$save=array('fecha'=>$f,'paciente'=>$pa,'num_af'=>$nf,'numauto'=>$na,'tsubtotal'=>$ts,'totpagseg'=>$tp,'totpagpa'=>$tpg,'medico'=>$med,'center_id'=>$cent,'area_id'=>$ar,'servicio'=>$serv,'codigoprestado'=>$cod,'rnc'=>$rn,'seguro_medico'=>$sm,'inserted_by'=>$this->input->post('created_by'),'updated_by'=>$this->input->post('created_by'),'inserted_time'=>$time,'updated_date'=>$time,'ncf_id'=>$id_ncf,'id_fac2'=>$if,'id_f'=>$if2);$this->model_admin->saveInvoiceArsClaim($save);};$this->session->set_userdata('id_ncf',$id_ncf);$this->session->set_userdata('is_admin',$this->input->post('is_admin'));$this->session->set_userdata('desde',$this->input->post('desde'));$this->session->set_userdata('hasta',$this->input->post('hasta'));$this->session->set_userdata('id_user',$this->input->post('created_by'));$this->session->set_userdata('id_patient',$this->input->post('id_patient'));}function invoice_ars_p_v(){$data['id_user']=$this->session->userdata['id_user'];$id_ncf=$this->session->userdata['id_ncf'];$data['is_admin']=$this->session->userdata['is_admin'];$data['desde']=$this->session->userdata['desde'];$data['id_patient']=$this->session->userdata['id_patient'];$data['hasta']=$this->session->userdata['hasta'];$data['areas']=$this->model_admin->get_serv_fac2_doc(0);$data['area']="";$data['after_save']=1;$data['area_id']="";$data['id_ncf']=$id_ncf;$invoice=$this->model_admin->getNewinvoice($id_ncf);$data['invoice']=$invoice;$data['cnt']=count($invoice);$data['nota_ncf']=$this->model_admin->getNcf($id_ncf);$this->load->view('medico/billing/invoice_ars_claim/after-save',$data);}function ncfDateRange(){$id_user=$this->input->post('id_user');$sql="SELECT fecha FROM  invoice_ars_claims WHERE medico=$id_user group by fecha ORDER BY fecha DESC";$querysig=$this->db->query($sql);echo '<option value="" ></option>';foreach($querysig->result()as $row){$fecha=date("d-m-Y",strtotime($row->fecha));echo '<option value="'.$row->fecha.'">'.$fecha.'</option>';}}public function factura_reporte_con_ars($perfil,$id_user,$admin_position_centro) {if($perfil=="Medico"){ $data['where_report']="where medico=$id_user"; }elseif($perfil=="Admin"){if($admin_position_centro){$data['where_report']="where center_id=$admin_position_centro";}else{ $data['where_report']="";} }else{ $data['where_report']="where inserted_by=$id_user"; } $this->load->view('medico/billing/invoice_ars_claim/report-fac-ars', $data ); }}